<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI手机应用</title>
    <style>
        /* 样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-container {
            width: 380px;
            height: 666px;
            background: white;
            border: 16px solid #000;
            border-radius: 60px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            background: white;
        }

        .interface.active {
            opacity: 1;
            pointer-events: all;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 5px solid #000;
            position: relative;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .toggle-persona {
            position: absolute;
            right: 0;
            top: 0;
            background: white;
            border: 1px solid #000;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .scrollable-content {
            height: calc(100% - 120px);
            overflow-y: auto;
            padding-right: 5px;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE和Edge */
        }
        
        .scrollable-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        } 
        
        .persona-editor {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-bottom: 300px;
        }

        .persona-editor.expanded {
            max-height:  100px;
        }
        
        .persona-form {
            padding: 15px;
            border: 2px solid #000;
            border-radius: 5px;
            background: #fafafa;
        }        

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            background: white;
        }

        .persona-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .persona-actions button {
            flex: 1;
            padding: 5px;
            border: 1px solid #000;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            min-width: 50px;
        }
        
        input, textarea {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 15px;
            width: 100%;
            background: white;
        }

        input:focus, textarea:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none;
            box-shadow: none;
        }

        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0px 1000px white inset;
            border: 3px solid #4a6ee0 !important;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 300px;
        }

        .chat-messages {
            flex: 1;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #000;
            margin-bottom: 10px;
            background: #fafafa;
        } 
        
        .chat-input input:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .message {
            max-width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
        }

        .user-message {
            background: white;
            border: 1px solid #000;
            margin-left: auto;
        }

        .ai-message {
            background: white;
            border: 1px solid #000;
            margin-right: auto;
        }

        .message-sender {
            font-size: 16px;
            color: #000;
            margin-bottom: 3px;
            font-weight: 800;
        }
        
        .message-content {
            font-size: 13px; 
        }

        .message-actions {
            position: absolute;
            top: 5px;
            display: none;
            right: 10px;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            background: rgba(255,255,255,0.9);
            border: 1px solid #000;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .message.editing {
            background: #FFFFFF;
            border-color: #FFFFFF;
        }

        .message.deleting {
            opacity: 0;
            transform: scale(0.5);
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-input input:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .input:focus, textarea:focus, select:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
        }

        .edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .edit-actions button {
            padding: 5px 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .chat-input button {
            padding: 10px 20px;
            border: 1px solid #000;
            background: white;   
            border-radius: 5px;
            cursor: pointer;
        }

        .persona-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #000;
        }

        .persona-section h3 {
            margin-bottom: 10px;
        }

        .persona-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            margin-bottom: 10px;
            border-radius: 5px;
        } 

        .persona-buttons {
            display: flex;
            gap: 10px;
        }

        .persona-buttons button {
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        } 

        .api-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #000;
        }

        .api-section h3 {
            margin-bottom: 10px;
        }

        .api-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;   
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .api-buttons button {
            padding: 8px 15px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;  
            cursor: pointer;
            flex: 1;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }   

        .status-success {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .status-error {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .style-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 500px;
        }  

        .ai-circle {
            width: 120px;
            height: 120px;
            border: 3px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            font-weight: bold;
            margin: 20px 0;
        }

        .css-editor {
            width: 100%;
            height: 200px;
            padding: 10px;    
            border: 1px solid #000;
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
        }

        .apply-css {
            width = 100%;
            padding: 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;   
        }

        .navigation {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            background: white;
            border-top: 1px solid #000;
            z-index: 10;
        }

        .nav-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: white;
            cursor: pointer;
            text-align: center;
            border-right: 1px solid #000;
        }

        .nav-button:last-child {
            border-right: none;
        }

        .nav-button.active {
            background: #f0f0f0;
        }   

        .interface.exiting {
            transform: translateX(-100%);
            opacity: 0;
        }

        .interface.entering {
            transform: translateX(100%);
        }

        .interface.entering.active {
            transform: translateX(0);
        }

        .scroll-hint {   
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            display: none;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            margin: 0 20px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .confirm-buttons button { 
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background: #00ff00;
        }

        .status-offline {
            background: #ff0000;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .typing-indicator {
            display: inline-block;
            margin-left: 5px;  
        }

        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: #000;
            border-radius: 50%;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }   

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #000;
            margin-top: 10px;   
            padding: 10px;
            background: #fafafa;
        }

        .model-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .model-item:hover {
            background: #f0f0f0;
        }

        .model-item:last-child {
            border-bottom: none;
        }   

        .refresh-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .refresh-button {
            background: white;
            border: 1px solid #000;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }    

        .last-updated {
            font-size: 12px;
            color: #666;
        }

        .model-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 5px;
            background: #ffffff;   
            border-radius: 3px;
        }

        .current-model {
            font-size: 14px;
            font-weight: 600;
        }

        .model-badge {
            background: #000;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 12px;
        }    

        .persona-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;    
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            border: 2px solid #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #000;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;    
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;   
            justify-content: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .persona-tabs {
            display: flex;
            border-bottom: 1px solid #000;
            margin-bottom: 15px;
        }     

        .persona-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .persona-tab.active {
            border-bottom: 2px solid #000;
            font-weight: 600;
        }

        .persona-form-section {
            display: none;
        }     

        .persona-form-section.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .form-section h4 {
            margin-bottom: 10px;
            font-size: 14px;  
        }

        .persona-preview {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
            background: #fafafa;
            font-size: 12px;
        }

        .persona-preview h5 {
            margin-bottom: 5px;
            font-size: 12px;     
        }   
    </style>
</head>
<body>
    <!-- 新的确认对话框 -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-content">
            <h3>确认删除</h3>
            <p>您确定要删除这条消息吗？此操作不可撤销。</p>
            <div class="confirm-buttons">
                <button id="confirm-delete-btn">确认删除</button>
                <button id="cancel-delete-btn">取消</button>
            </div>     
        </div>
    </div>

    <div class="persona-modal" id="persona-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>人设管理</h3>
                <button class="close-modal" onclick="closePersonaModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="persona-tabs">
                    <button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button>
                    <button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button>
                </div>    
                
                <div class="persona-form-section active" id="ai-persona-section">
                    <div class="form-section">
                        <h4>角色人设</h4>
                        <div class="form-group">
                            <label for="ai-persona-name">姓名</label>
                            <input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名...">
                        </div>
                        <div class="form-group">
                            <label for="ai-persona-desc">人设描述</label>
                            <textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea>
                        </div>    
                        <div class="persona-actions">
                            <button onclick="saveAIPersona()">保存人设</button>
                            <button onclick="loadAIPersona()">加载人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="ai-persona-preview">
                        <h5>人设预览：</h5>
                        <div id="ai-preview-content">暂无人设</div>
                    </div>
                </div>
                
                <div class="persona-form-section" id="user-persona-section">
                    <div class="form-section">
                        <h4>我的人设</h4>
                        <div class="form-group">
                            <label for="user-persona-name">我的姓名</label>
                            <input type="text" class="form-input" id="user-persona-name" placeholder="输入您的姓名...">
                        </div>   
                        <div class="form-group">
                            <label for="user-persona-desc">我的人设描述</label>
                            <textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入您的人设描述..."></textarea>
                        </div>
                        <div class="persona-actions">
                            <button onclick="saveUserPersona()">保存我的人设</button>
                            <button onclick="loadUserPersona()">加载我的人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="user-persona-preview">
                        <h5>我的人设预览：</h5>
                        <div id="user-preview-content">暂无我的人设</div>
                    </div>
                </div>
            </div>
        </div>
    </div>    

    <div class="phone-container">
        <div class="screen">
            <div class="interface active" id="chat-interface">
                <div class="header">
                    <h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1>
                    <button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button>
                </div>
                
                <div class="scrollable-content">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- 消息将通过JavaScript动态加载 -->
                        </div>
                        <div class="chat-input">
                            <input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)">
                            <button onclick="sendMessage()" id="send-button">发送</button>
                        </div>
                    </div>      
                    <div class="persona-section">
                        <h3>基础人设设置</h3>
                        <input type="text" class="persona-input" id="persona-input" placeholder="输入角色人设描述...">
                        <div class="persona-buttons">
                            <button onclick="savePersona()">保存人设</button>
                            <button onclick="editPersona()">编辑人设</button>
                            <button onclick="applyPersona()">应用人设</button>
                        </div>
                    </div>
                    <div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <div class="interface" id="api-interface">
                <div class="header">
                    <h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1>
                </div>       
                <div class="scrollable-content">
                    <div class="api-section">
                        <h3>API提供商</h3>
                        <select class="api-input" id="api-provider" onchange="updateApiEndpoints()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>     
                    <div class="api-section">
                        <h3>API端点配置</h3>
                        <input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1">
                        <input type="password" class="api-input" id="api-key" placeholder="输入API密钥...">
                        <div class="api-buttons">
                            <button onclick="testApiConnection()">测试API连接</button>
                            <button onclick="refreshModels()">刷新模型列表</button>
                            <button onclick="saveApiConfig()">保存配置</button>
                            <button onclick="clearApiConfig()">清除配置</button>   
                        </div>
                        <div class="api-status" id="api-status"></div>
                    </div>
                    <div class="api-section">
                        <h3>模型选择</h3>
                        <div class="model-info">
                            <span class="current-model" id="current-model-display">当前模型: 未选择</span>
                            <span class="model-badge" id="model-provider-badge">OpenAI</span>
                        </div>    
                        <select class="api-input" id="model-select" onchange="updateSelectedModel()">
                            <option value="">请选择模型</option>
                        </select>
                        <div class="refresh-status">
                            <button class="refresh-button" onclick="refreshModels()">刷新模型</button>
                            <span class="last-updated" id="last-updated">上次更新: 从未</span>
                        </div>
                        <div class="model-list" id="model-list" style="display: none;">
                            <div class="api-status" id="models-status"></div>
                        </div>
                    </div>    
                    <div class="api-section">
                        <h3>高级设置</h3>
                        <div class="form-group">
                            <label for="temperature">温度 (0-2)</label>
                            <input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()">
                            <span id="temperature-value">0.7</span>
                        </div>  
                        <div class="form-group">
                            <label for="max-tokens">最大令牌数</label>
                            <input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000">
                        </div>
                    </div>
                    <div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <div class="interface" id="style-interface">
                <div class="header">
                    <h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="style-container">
                        <div class="ai-circle">AI</div>
                        <textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message {     
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {
    margin-left: auto;
    background: #f8f8f8;
}    

.ai-message {
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {    
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}</textarea> 
                        <div class="api-buttons">
                            <button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button>
                            <button class="apply-css" onclick="resetCSS()">重置CSS</button>
                            <button class="apply-css" onclick="exportCSS()">导出CSS</button>
                            <button class="apply-css" onclick="importCSS()">导入CSS</button>
                        </div>
                    </div>
                    <div class="api-section">
                        <h3>主题设置</h3>
                        <div class="api-buttons">
                            <button onclick="setTheme('light')">浅色主题</button>
                            <button onclick="setTheme('dark')">深色主题</button>
                            <button onclick="setTheme('high-contrast')">高对比度</button>
                        </div>    
                    </div>
                    <div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>
        </div>

        <div class="navigation">
            <button class="nav-button active" onclick="switchInterface('chat')">聊天</button>
            <button class="nav-button" onclick="switchInterface('api')">API配置</button>
            <button class="nav-button" onclick="switchInterface('style')">美化</button>
        </div>
    </div>

    <script>
        // 完整的聊天记录管理类，包含监听功能
        class ChatManager {
            constructor() {
                 this.messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                 this.currentEditingId = null;
                 this.listeners = []; // 监听器数组
        
                 // 代理messages数组以实现监听
                 this.messages = this.createObservableArray(this.messages);
            }           

            // 修复 createObservableArray 方法
            createObservableArray(array) {
                const self = this;
                return new Proxy(array, {
                    set(target, property, value) {
                        const result = Reflect.set(target, property, value);
                        // 触发变化监听
                         self.notifyListeners('messagesChanged', target);
                         self.saveMessages();
                         return result;
                    },
                   // 添加对数组方法的监听
                   get(target, property) {
                       const value = Reflect.get(target, property);
                       if (typeof value === 'function') {
                           return function(...args) {
                               const result = value.apply(target, args);
                               // 当调用 push, splice 等方法时触发监听
                               if (['push', 'pop', 'shift', 'unshift', 'splice'].includes(property)) {
                                  self.notifyListeners('messagesChanged', target);
                                  self.saveMessages();
                               }
                               return result;
                           };
                       }
                       return value;
                   }
               });
            }

            // 添加监听器
            addListener(event, callback) {
                 this.listeners.push({ event, callback });
            }

            // 通知监听器
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    if (listener.event === event) {
                        listener.callback(data);
                    }
                });
            }

            saveMessages() {
                 localStorage.setItem('chatMessages', JSON.stringify(this.messages));
            }
            
            addMessage(sender, content, type = 'text') {
                 const message = {
                      id: Date.now() + Math.random().toString(36).substr(2, 9),
                      sender: sender,
                      content: content,
                      type: type,
                      timestamp: new Date().toISOString()
                 };
                 this.messages.push(message);
                 // saveMessages() 会通过代理自动调用
                 return message;     
            }
            
            updateMessage(id, newContent) {
                 const message = this.messages.find(msg => msg.id === id);
                 if (message) {
                     message.content = newContent;
                     message.timestamp = new Date().toISOString();
                     this.saveMessages();
                     this.notifyListeners('messageUpdated', message); // 手动触发更新事件
                     return true;
                 }
                 return false;
            }
            
            deleteMessage(id) {
                const index = this.messages.findIndex(msg => msg.id === id);
                if (index !== -1) {   
                    const deletedMessage = this.messages[index];
                    this.messages.splice(index, 1);
                    // 保存到 localStorage
                    this.saveMessages();
                    this.notifyListeners('messageDeleted', deletedMessage);
                    return true;
                }
                return false;
            }

            getMessages() {
                 return [...this.messages];
            }
        }
        
        // API服务类
        class ApiService {
            constructor() {    
                this.config = JSON.parse(localStorage.getItem('apiConfig')) || {
                    provider: 'openai',
                    apiKey: '',
                    apiUrl: 'https://api.openai.com/v1',
                    model: 'gpt-3.5-turbo'
                };
            }             

            async getModels() {
                try {
                    const response = await fetch(`${this.config.apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });  
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.data.map(model => model.id);
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    throw error;
                }
            }      

            async chatWithRole(rolePrompt, userMessage, temperature = 0.7) {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }   

                // 获取AI人设和用户人设
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                
                // 构建完整的系统提示
                let systemPrompt = rolePrompt;
                
                // 添加角色人设信息
                if (aiPersona.name || aiPersona.description) {
                    systemPrompt += `\n\nAI角色信息：`;
                    if (aiPersona.name) systemPrompt += `\n- 姓名：${aiPersona.name}`;
                    if (aiPersona.description) systemPrompt += `\n- 描述：${aiPersona.description}`;
                }   
                
                // 添加用户人设信息
                if (userPersona.name || userPersona.description) {
                    systemPrompt += `\n\n用户信息：`;
                    if (userPersona.name) systemPrompt += `\n- 姓名：${userPersona.name}`;
                    if (userPersona.description) systemPrompt += `\n- 描述：${userPersona.description}`;
                }

                // 获取最近9条消息作为上下文（排除当前消息）
                const allMessages = appState.chatManager.getMessages();
                // 过滤掉当前正在生成的消息，取最后9条（为当前消息留出位置）
                const recentMessages = allMessages
                    .filter(msg => msg.content !== '正在思考...' && msg.content !== userMessage)
                    .slice(-9);

                // 构建消息数组 - 包含系统提示、历史上下文
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // 添加历史消息到上下文
                recentMessages.forEach(msg => {
                    if (msg.sender === 'user') {
                        messages.push({ role: 'user', content: msg.content });
                    } else {
                        messages.push({ role: 'assistant', content: msg.content });
                    }
                });

                // 添加当前用户消息（确保不会重复）
                messages.push({ role: 'user', content: userMessage });

                console.log('发送到API的消息上下文:', messages);

                try {   
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        },     
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: parseInt(document.getElementById('max-tokens').value) || 1000
                        })
                    });      

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API请求失败: ${errorData.error?.message || response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API调用失败:', error);
                    throw error;
                }
            }  

            async testConnection() {
                try {
                    const models = await this.getModels();
                    return { success: true, models: models };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                localStorage.setItem('apiConfig', JSON.stringify(this.config));
            }    

            getCurrentConfig() {
                return { ...this.config };
            }
        }

        // 全局状态
        const appState = {
            currentPersona: null,
            apiConfig: {},
            customCSS: '',
            isGenerating: false,
            models: [],
            lastUpdated: null,
            apiService: new ApiService(),
            chatManager: new ChatManager(),
            currentPersonaTab: 'ai',
            currentEditingMessageId: null
        };  

        const API_ENDPOINTS = {
            openai: 'https://api.openai.com/v1',
            anthropic: 'https://api.anthropic.com/v1',
            google: 'https://generativelanguage.googleapis.com/v1'
        };

        const MODEL_LISTS = {
            openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'],
            anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],
            google: ['gemini-pro', 'gemini-pro-vision']
        };

        let currentInterface = 'chat';     
        let deleteMessageId = null;
        
        // 修复监听器 - 确保消息更新时重新渲染
        appState.chatManager.addListener('messagesChanged', (messages) => {
            console.log('消息列表发生变化:', messages);
            renderChatMessages();
        });

        appState.chatManager.addListener('messageUpdated', (message) => {
            console.log('消息被更新:', message);
            renderChatMessages(); // 确保界面更新
        });

        appState.chatManager.addListener('messageDeleted', (message) => {
            console.log('消息被删除:', message);
            renderChatMessages(); // 确保界面更新
        });

        // 删除相关函数
        function showDeleteConfirm(messageId) {
            deleteMessageId = messageId;
            document.getElementById('confirm-dialog').style.display = 'flex';
        }

        function confirmDelete() {
            if (!deleteMessageId) {
                document.getElementById('confirm-dialog').style.display = 'none';
                return;
            }

            console.log('确认删除消息ID:', deleteMessageId);

            // 执行删除操作
            const success = appState.chatManager.deleteMessage(deleteMessageId);
            console.log('删除结果:', success);

            // 重新渲染界面
            renderChatMessages();

            // 隐藏对话框
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function cancelDelete() {
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function switchInterface(interfaceName) {
            if (interfaceName === currentInterface) return;
            
            const oldInterface = document.getElementById(`${currentInterface}-interface`);
            const newInterface = document.getElementById(`${interfaceName}-interface`);
            const oldNavButton = document.querySelector(`.nav-button[onclick="switchInterface('${currentInterface}')"]`);
            const newNavButton = document.querySelector(`.nav-button[onclick="switchInterface('${interfaceName}')"]`);
            
            oldInterface.classList.add('exiting');
            
            setTimeout(() => {
                oldInterface.classList.remove('active');
                oldInterface.classList.remove('exiting');
                newInterface.classList.add('active', 'entering');
                
                setTimeout(() => {
                    newInterface.classList.remove('entering');
                }, 50);    
                
                oldNavButton.classList.remove('active');
                newNavButton.classList.add('active');
                
                currentInterface = interfaceName;
                
                const scrollContent = newInterface.querySelector('.scrollable-content');
                if (scrollContent) {
                    scrollContent.scrollTop = 0;
                }

                updateStatusIndicators();
            }, 300);
        }       

        function openPersonaModal() {
            document.getElementById('persona-modal').style.display = 'flex';
            loadPersonaPreviews();
        }

        function closePersonaModal() {
            document.getElementById('persona-modal').style.display = 'none';
        }

        function switchPersonaTab(tabName) {
            document.querySelectorAll('.persona-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.persona-form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelector(`.persona-tab[onclick="switchPersonaTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-persona-section`).classList.add('active');
            
            appState.currentPersonaTab = tabName;
            loadPersonaPreviews();
        }     

        function loadPersonaPreviews() {
            const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            
            if (aiPersona.name || aiPersona.description) {
                document.getElementById('ai-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${aiPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${aiPersona.description || '未设置'}
                `;
            } else {   
                document.getElementById('ai-preview-content').textContent = '暂无角色人设';
            }
            
            if (userPersona.name || userPersona.description) {
                document.getElementById('user-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${userPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${userPersona.description || '未设置'}
                `;
            } else {
                document.getElementById('user-preview-content').textContent = '暂无我的人设';
            }
        }   

        function saveAIPersona() {
            const name = document.getElementById('ai-persona-name').value.trim();
            const desc = document.getElementById('ai-persona-desc').value.trim();
            
            const persona = {
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };     
            
            localStorage.setItem('aiPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            alert('角色人设保存成功！');
        }

        function loadAIPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            document.getElementById('ai-persona-name').value = savedPersona.name || '';
            document.getElementById('ai-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            alert('角色人设加载成功！');
        }

        function saveUserPersona() {
            const name = document.getElementById('user-persona-name').value.trim();
            const desc = document.getElementById('user-persona-desc').value.trim();
            
            const persona = {    
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('userPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            alert('我的人设保存成功！');
        }

        function loadUserPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            document.getElementById('user-persona-name').value = savedPersona.name || '';
            document.getElementById('user-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            alert('我的人设加载成功！');
        }   

        function editMessage(button, messageId) {
            const messageElement = button.closest('.message');
            const contentElement = messageElement.querySelector('.message-content');
            const currentContent = contentElement.textContent;
            
            // 进入编辑模式
            messageElement.classList.add('editing');
            contentElement.innerHTML = `
                <textarea class="edit-input">${currentContent}</textarea>
                <div class="edit-actions">
                    <button onclick="saveEdit('${messageId}')">保存</button>
                    <button onclick="cancelEdit('${messageId}')">取消</button>
                </div>
            `;
            
            appState.currentEditingMessageId = messageId;
        }

        function saveEdit(messageId) {    
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            const textarea = messageElement.querySelector('.edit-input');
            const newContent = textarea.value.trim();
            
            if (newContent) {
                // 更新消息内容
                if (appState.chatManager.updateMessage(messageId, newContent)) {
                    messageElement.classList.remove('editing');
                    messageElement.querySelector('.message-content').innerHTML = newContent;
                }
            }
            
            appState.currentEditingMessageId = null;
        }    

        function cancelEdit(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            messageElement.classList.remove('editing');
            
            // 恢复原始内容
            const message = appState.chatManager.messages.find(msg => msg.id === messageId);
            if (message) {
                messageElement.querySelector('.message-content').innerHTML = message.content;
            }
            
            appState.currentEditingMessageId = null;
        }

        function updateStatusIndicators() {
            const chatStatus = document.getElementById('chat-status');
            const apiStatus = document.getElementById('api-status-indicator');
            const styleStatus = document.getElementById('style-status');
            
            if (appState.currentPersona) {
                chatStatus.className = 'status-indicator status-online';
                chatStatus.title = '人设已应用';
            } else {
                chatStatus.className = 'status-indicator status-offline';
                chatStatus.title = '使用默认人设';
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey && currentConfig.model) {
                apiStatus.className = 'status-indicator status-online';
                apiStatus.title = 'API配置完成';
            } else {
                apiStatus.className = 'status-indicator status-offline';
                apiStatus.title = 'API未配置';
            }    
            
            if (appState.customCSS) {
                styleStatus.className = 'status-indicator status-online';
                styleStatus.title = '自定义样式已应用';
            } else {
                styleStatus.className = 'status-indicator status-offline';
                styleStatus.title = '使用默认样式';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function renderChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            const messages = appState.chatManager.getMessages();
            
            console.log('渲染消息列表，消息数量:', messages.length);
             console.log('消息内容:', messages);
            
            chatMessages.innerHTML = '';      
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                const isUser = message.sender === 'user';
                const aiName = getCurrentAiName();
                const userName = getCurrentUserName(); // 获取用户人设名称
                
                messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                messageElement.innerHTML = `
                    <div class="message-sender">${isUser ? userName : aiName}</div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="message-action" title="编辑" onclick="editMessage(this, '${message.id}')">✤</button>
                        <button class="message-action" title="删除" onclick="showDeleteConfirm('${message.id}')">✖</button>
                    </div>    
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentAiName() {
            // 从保存的AI人设中获取名称
            const savedPersona = localStorage.getItem('aiPersona');
             if (savedPersona) {
                 try {
                     const persona = JSON.parse(savedPersona);
                     // 如果设置了AI名称，则返回名称，否则返回默认名称
                      return persona.name || 'AI';
                 } catch (e) {
                     console.error('解析AI人设失败:', e);
                     return 'AI';
                 }
             }
            // 如果没有保存的人设，返回默认名称
            return 'AI助手';
        }

        function getCurrentUserName() {
            // 从保存的用户人设中获取名称
            const savedPersona = localStorage.getItem('userPersona');
            if (savedPersona) {
                try {
                    const persona = JSON.parse(savedPersona);
                    // 如果设置了用户名称，则返回名称，否则返回默认名称
                    return persona.name || '您';
                } catch (e) {
                    console.error('解析用户人设失败:', e);
                    return '您';
                }
            }
            // 如果没有保存的人设，返回默认名称
            return '您';
        }

        async function sendMessage() {
            if (appState.isGenerating) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;
            
            const sendButton = document.getElementById('send-button');
            
            // 先清空输入框，防止重复发送
            input.value = '';
            appState.isGenerating = true;
            sendButton.disabled = true;  
            sendButton.textContent = '生成中...';
            
            // 添加用户消息
            appState.chatManager.addMessage('user', message);
            renderChatMessages();
            
            // 添加思考消息
            const thinkingMessage = appState.chatManager.addMessage('ai', '正在思考...');
            renderChatMessages();
            
            try {
                const rolePrompt = getCurrentRolePrompt();
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.7;
                const response = await appState.apiService.chatWithRole(rolePrompt, message, temperature);
                
                // 更新角色回复    
                appState.chatManager.updateMessage(thinkingMessage.id, response);
                renderChatMessages();
                
            } catch (error) {
                // 更新错误消息       
                appState.chatManager.updateMessage(thinkingMessage.id, `抱歉，生成回复时出现错误：${error.message}`);
                renderChatMessages();
                
                console.error('API调用错误:', error);
            } finally {
                appState.isGenerating = false;
                sendButton.disabled = false;
                sendButton.textContent = '发送';
            }
        }

        function getCurrentRolePrompt() {
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {    
                const persona = JSON.parse(savedPersona);
                return persona.description || '你是一个有用的AI助手';
            }
            
            const basicPersona = document.getElementById('persona-input').value;
            return basicPersona || '你是一个有用的AI助手';
        }

        function updateApiEndpoints() {  
            const provider = document.getElementById('api-provider').value;
            const endpointInput = document.getElementById('api-url');
            const modelSelect = document.getElementById('model-select');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (provider !== 'custom') {
                endpointInput.value = API_ENDPOINTS[provider] || '';
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
                modelSelect.innerHTML = '<option value="">请选择模型</option>';
                const models = MODEL_LISTS[provider] || [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function updateSelectedModel() {
            const modelSelect = document.getElementById('model-select');
            const currentModelDisplay = document.getElementById('current-model-display');
            const selectedModel = modelSelect.value;
            
            if (selectedModel) {
                currentModelDisplay.textContent = `当前模型: ${selectedModel}`;
                appState.apiService.updateConfig({ model: selectedModel });
            } else {
                currentModelDisplay.textContent = '当前模型: 未选择';
                appState.apiService.updateConfig({ model: '' });
            }
        }

        async function testApiConnection() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            
            if (!apiKey) {    
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '测试连接中...';
            
            try {     
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });
                
                const result = await appState.apiService.testConnection();
                
                if (result.success) {
                    statusDiv.className = 'api-status status-success';
                    statusDiv.textContent = '✔ API连接成功！';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ API连接失败: ${error.message}`;
            }   
            
            updateStatusIndicators();
        }

        async function refreshModels() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            const lastUpdated = document.getElementById('last-updated');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (!apiKey) { 
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请先输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '获取模型中...';
            
            try {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });    
                
                const models = await appState.apiService.getModels();
                updateModelSelect(models);
                statusDiv.className = 'api-status status-success';
                statusDiv.textContent = `✔ 成功获取 ${models.length} 个模型`;
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ 获取模型失败: ${error.message}`;
                
                const models = MODEL_LISTS[provider] || ['default-model'];
                updateModelSelect(models);
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();   
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
            }
        }

        function updateModelSelect(models) {
            const modelSelect = document.getElementById('model-select');
            
            modelSelect.innerHTML = '<option value="">请选择模型</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }   

        function saveApiConfig() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const model = document.getElementById('model-select').value;
            const provider = document.getElementById('api-provider').value;
            const temperature = document.getElementById('temperature').value;
            const maxTokens = document.getElementById('max-tokens').value;
            
            if (apiKey && model) {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl,
                    model: model
                });      
                
                updateStatusIndicators();
                alert('API配置保存成功！');
            } else {
                alert('请填写完整的API配置信息。');
            }
        }

        function clearApiConfig() {
            document.getElementById('api-key').value = '';
            document.getElementById('api-url').value = 'https://api.openai.com/v1';
            document.getElementById('model-select').innerHTML = '<option value="">请选择模型</option>';
            document.getElementById('api-provider').value = 'openai';
            document.getElementById('temperature').value = '0.7';
            document.getElementById('max-tokens').value = '1000';
            document.getElementById('current-model-display').textContent = '当前模型: 未选择';
            
            appState.apiService.updateConfig({
                provider: 'openai',      
                apiKey: '',
                apiUrl: 'https://api.openai.com/v1',
                model: ''
            });
            
            updateStatusIndicators();  
            alert('API配置已清除！');
        }

        function applyGlobalCSS() {
            const cssCode = document.getElementById('css-editor').value;
            let styleElement = document.getElementById('global-css');
            
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'global-css';
                document.head.appendChild(styleElement);
            }    
            
            styleElement.textContent = cssCode;
            appState.customCSS = cssCode;
            localStorage.setItem('customCSS', cssCode);
            updateStatusIndicators();
            alert('全局CSS应用成功！');
        }

        function resetCSS() {
            document.getElementById('css-editor').value = `/* 在这里输入您的自定义CSS */
.message {
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {   
    margin-left: auto;
    background: #f8f8f8;
}

.ai-message {  
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}`;     
            appState.customCSS = '';
            localStorage.removeItem('customCSS');
            
            const styleElement = document.getElementById('global-css');
            if (styleElement) {
                styleElement.remove();
            }
            
            updateStatusIndicators();
            alert('CSS已重置为默认值！');
        }     

        function exportCSS() {
            const cssCode = document.getElementById('css-editor').value;
            const blob = new Blob([cssCode], { type: 'text/css' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;    
            a.download = 'ai_app_styles.css';
            a.click();
            URL.revokeObjectURL(url);
            alert('CSS代码已导出！');
        }

        function importCSS() {    
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.css';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('css-editor').value = e.target.result;
                    alert('CSS代码已导入！');
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function setTheme(theme) {  
            const body = document.body;
            body.className = theme + '-theme';
            localStorage.setItem('appTheme', theme);
            alert(`已切换到${theme}主题！`);
        }

        function updateTemperatureValue() {
            const temperature = document.getElementById('temperature');
            const valueSpan = document.getElementById('temperature-value');
            valueSpan.textContent = temperature.value;
        }

        function savePersona() {
            const personaInput = document.getElementById('persona-input');
            const persona = personaInput.value.trim();
            if (persona) {
                localStorage.setItem('aiPersona', JSON.stringify({description: persona}));
                alert('人设保存成功！');
            }
        }       

        function editPersona() {  
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';
                alert('已加载保存的人设，您可以进行编辑。');
            }
        }

        function applyPersona() {
            const persona = localStorage.getItem('aiPersona');
            if (persona) {
                alert('人设应用成功！当前对话将使用新的人设。');
            } else {
                alert('请先保存人设再应用。');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 绑定确认删除按钮
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete);
            
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';   
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey) {
                document.getElementById('api-key').value = currentConfig.apiKey || '';
                document.getElementById('api-url').value = currentConfig.apiUrl || 'https://api.openai.com/v1';
                document.getElementById('api-provider').value = currentConfig.provider || 'openai';
                document.getElementById('temperature').value = 0.7;
                document.getElementById('max-tokens').value = 1000;
                
                if (currentConfig.model) {
                    const modelSelect = document.getElementById('model-select');
                    setTimeout(() => {  
                        const options = Array.from(modelSelect.options);
                        const option = options.find(opt => opt.value === currentConfig.model);
                        if (option) {
                            option.selected = true;
                            updateSelectedModel();
                        }
                    }, 100);
                }
            }   
            
            const savedCSS = localStorage.getItem('customCSS');    
            if (savedCSS) {
                document.getElementById('css-editor').value = savedCSS;
                appState.customCSS = savedCSS;
                
                let styleElement = document.getElementById('global-css');
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = 'global-css';
                    document.head.appendChild(styleElement);
                }
                styleElement.textContent = savedCSS;
            }
            
            const savedTheme = localStorage.getItem('appTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            }     
            
            updateTemperatureValue();
            document.getElementById('temperature').addEventListener('input', updateTemperatureValue);
            
            updateApiEndpoints();
            
            updateStatusIndicators();
            
            // 渲染聊天记录
            renderChatMessages();
        });
    </script>
</body>
</html>
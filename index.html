<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI手机应用</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-container {
            width: 380px;
            height: 666px;
            background: white;
            border: 16px solid #000;
            border-radius: 36px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }

        .screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 20px;
        }

        .interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            background: white;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
        }

        .interface.active {
            opacity: 1;
            pointer-events: all;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 5px solid #000;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .back-button {
            position: absolute;
            left: 0;
            background: white;
            border: 1px solid #000;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .toggle-persona {
            position: absolute;
            right: 0;
            top: 0;
            background: white;
            border: 1px solid #000;
            padding: 6px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .desktop-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            color: #000;
            padding-top: 40px;
        }

        .desktop-interface.active {
            display: flex;
        }

        .app-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 50px;
            padding: 0 20px;
        }

        .app-icon {
            width: 80px;
            height: 80px;
            background: #ffffff;
            border-radius: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 30px;
        }

        .app-icon:hover {
            transform: scale(1.1);
            background: #000000; 
        }

        .app-label {
            margin-top: 10px;
            font-size: 15px;
            text-align: center;
            color: #000;
        }

        .app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .desktop-time {
            font-size: 110px;
            font-weight: 1000;
            margin-bottom: 20px;
            color: #000;
        }

        .desktop-signature {
            font-size: 18px;
            color: #000;
            margin-bottom: 50px;
            text-align: center;
            min-height: 24px;
            padding: 0 20px;
            width: 100%;
            cursor: text;
            transition: all 0.3s ease;
            outline: none;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .desktop-signature:focus {
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
        }

        .chat-interface {
            padding-bottom: 0;
        }

        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 0;
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .scrollable-content::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #000;
            background: #fafafa;
            margin-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .chat-messages::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-input-container {
            flex-shrink: 0;
            margin-top: auto;
            padding: 5px 0;
            background: white;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .chat-input button {
            padding: 10px 20px;
            border: 1px solid #000;
            background: white;   
            border-radius: 5px;
            cursor: pointer;
        }

        .persona-section {
            margin-top: 10px;
            padding: 15px;
            border: 1px solid #000;
        }

        .persona-section h3 {
            margin-bottom: 10px;
        }

        .persona-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            margin-bottom: 10px;
            border-radius: 5px;
        } 

        .persona-buttons {
            display: flex;
            gap: 10px;
        }

        .persona-buttons button {
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        } 

        /* 新增备份功能样式 */
        .backup-section {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #000;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .backup-section h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .backup-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .backup-buttons button {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            min-width: 120px;
        }
        
        .backup-buttons button:hover {
            background: #f0f0f0;
        }
        
        .backup-file-input {
            display: none;
        }
        
        .backup-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
            font-size: 12px;
        }
        
        .backup-success {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .backup-error {
            background: #f0f0f0;
            border: 1px solid #000;
            color: #000;
        }
        
        .backup-info {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
            text-align: center;
        }

        .message {
            max-width: 100%;
            padding: 10px;
            margin: 5px 0;
            border-radius: 20px;
            word-wrap: break-word;
            position: relative;
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
        }

        .user-message {
            background: white;
            border: 1px solid #000;
            margin-left: auto;
        }

        .ai-message {
            background: white;
            border: 1px solid #000;
            margin-right: auto;
        }

        .message-sender {
            font-size: 16px;
            color: #000;
            margin-bottom: 3px;
            font-weight: 800;
        }
        
        .message-content {
            font-size: 13px; 
        }

        .message-actions {
            position: absolute;
            top: 5px;
            display: none;
            right: 10px;
            gap: 5px;
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-action {
            background: rgba(255,255,255,0.9);
            border: 1px solid #000;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .message.editing {
            background: #FFFFFF;
            border-color: #FFFFFF;
        }

        .message.deleting {
            opacity: 0;
            transform: scale(0.5);
            max-height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-input input:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
            box-shadow: none !important;
        }

        .input:focus, textarea:focus, select:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none !important;
        }

        .edit-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .edit-actions button {
            padding: 5px 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .persona-editor {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-bottom: 10px;
        }

        .persona-editor.expanded {
            max-height:  100px;
        }
        
        .persona-form {
            padding: 15px;
            border: 2px solid #000;
            border-radius: 5px;
            background: #fafafa;
        }        

        .form-group {
            margin-bottom: 5px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;
            border-radius: 9px;
            background: white;
        }

        .persona-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .persona-actions button {
            flex: 1;
            padding: 5px;
            border: 1px solid #000;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            min-width: 50px;
        }
        
        input, textarea {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 12px 15px;
            width: 100%;
            background: white;
        }

        input:focus, textarea:focus {
            border: 3px solid #4a6ee0 !important;
            outline: none;
            box-shadow: none;
        }

        input:-webkit-autofill {
            -webkit-box-shadow: 0 0 0px 1000px white inset;
            border: 3px solid #4a6ee0 !important;
        }

        .api-section {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #000;
        }

        .api-section h3 {
            margin-bottom: 10px;
        }

        .api-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #000;   
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .api-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .api-buttons button {
            padding: 8px 15px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;  
            cursor: pointer;
            flex: 1;
        }

        .api-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }   

        .status-success {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .status-error {
            background: #f0f0f0;
            border: 1px solid #000;
        }

        .style-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 400px;
        }  

        .ai-circle {
            width: 120px;
            height: 120px;
            border: 3px solid #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            font-weight: bold;
            margin: 20px 0;
        }

        .css-editor {
            width: 100%;
            height: 200px;
            padding: 10px;    
            border: 1px solid #000;
            border-radius: 8px;
            font-family: monospace;
            resize: vertical;
        }

        .apply-css {
            width = 100%;
            padding: 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;   
        }

        .app-navigation {
            position: relative;
            width: 100%;
            height: 2px;
            background: #000;
            flex-shrink: 0;
            display: none;
        }

        .desktop-interface .app-navigation {
            display: none;
        }

        #api-interface .app-navigation,
        #style-interface .app-navigation,
        #chat-interface .app-navigation {
            display: none;
        }

        .interface.exiting {
            transform: translateX(-100%);
            opacity: 0;
        }

        .interface.entering {
            transform: translateX(100%);
        }

        .interface.entering.active {
            transform: translateX(0);
        }

        .scroll-hint {   
            text-align: center;
            font-size: 10px;
            color: #666;
            margin-top: 10px;
            display: none;
        }

        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 20px;
            border: 2px solid #000;
            border-radius: 10px;
            text-align: center;
            max-width: 300px;
            margin: 0 20px;
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .confirm-buttons button { 
            flex: 1;
            padding: 8px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            transition: all 0.3s ease;
        }

        .status-online {
            background: #00ff00;
        }

        .status-offline {
            background: #ff0000;
        }

        .status-generating {
            background: #00ff00;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .typing-indicator {
            display: inline-block;
            margin-left: 5px;  
        }

        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            background: #000;
            border-radius: 50%;
            margin: 0 1px;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }   

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .model-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #000;
            margin-top: 10px;   
            padding: 10px;
            background: #fafafa;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .model-list::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .model-item {
            padding: 5px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .model-item:hover {
            background: #f0f0f0;
        }

        .model-item:last-child {
            border-bottom: none;
        }   

        .refresh-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .refresh-button {
            background: white;
            border: 1px solid #000;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }    

        .last-updated {
            font-size: 12px;
            color: #666;
        }

        .model-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 5px;
            background: #ffffff;   
            border-radius: 3px;
        }

        .current-model {
            font-size: 14px;
            font-weight: 600;
        }

        .model-badge {
            background: #000;
            color: white;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 12px;
        }    

        .persona-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }

        .modal-content {
            background: white;    
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            border: 2px solid #000;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px;
            border-bottom: 1px solid #000;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;    
        }

        .modal-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;   
            justify-content: center;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .modal-body::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }

        .persona-tabs {
            display: flex;
            border-bottom: 1px solid #000;
            margin-bottom: 15px;
        }     

        .persona-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border: none;
            background: white;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .persona-tab.active {
            border-bottom: 2px solid #000;
            font-weight: 600;
        }

        .persona-form-section {
            display: none;
        }     

        .persona-form-section.active {
            display: block;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #000;
            border-radius: 5px;
        }

        .form-section h4 {
            margin-bottom: 10px;
            font-size: 14px;  
        }

        .persona-preview {
            margin-top: 15px;
            padding: 10px;
            border: 1px solid #000;
            border-radius: 5px;
            background: #fafafa;
            font-size: 12px;
        }

        .persona-preview h5 {
            margin-bottom: 5px;
            font-size: 12px;     
        }
        
        .style-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            width: 100%;
        }
        
        .style-buttons button {
            flex: 1;
            padding: 10px;
            border: 1px solid #000;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            min-width: 120px;
        }

        /* 音乐播放器样式 - 优化后的版本 */
        .music-player {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: white;
        }
        
        /* 固定部分 - 唱片、歌曲信息、进度条、控制按钮 */
        .music-fixed-area {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px 5px;
            /* 减少底部内边距，使文件选择区域更靠近 */
        }
        
        /* 可滚动部分 - 文件上传和播放列表 */
        .music-scrollable-area {
            flex: 1;
            overflow-y: auto;
            padding: 5px 15px 15px;
            /* 减少顶部内边距，使内容更靠近固定区域 */
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .music-scrollable-area::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        /* 唱片区域 */
        .disc-container {
            width: 220px;
            height: 220px;
            margin: 15px 0 20px;
            /* 减少唱片区域的上下边距 */
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .disc {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, #333 0%, #000 100%);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* 去掉阴影效果 */
            position: relative;
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
        }
        
        .disc-center {
            width: 40px;
            height: 40px;
            background-color: #fff;
            border-radius: 50%;
            z-index: 2;
        }
        
        .disc.playing {
            animation-play-state: running;
        }
        
        /* 歌曲信息 */
        .song-info {
            margin-bottom: 15px;
            /* 减少歌曲信息的底部边距 */
            width: 100%;
            text-align: center;
        }
        
        .song-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #000;
        }
        
        .song-artist {
            font-size: 14px;
            color: #555;
        }
        
        /* 进度条 */
        .progress-container {
            width: 100%;
            margin-bottom: 15px;
            /* 减少进度条的底部边距 */
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: #555;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #ddd;
            border-radius: 2px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: #000;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        
        /* 控制按钮 */
        .control-buttons {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-bottom: 15px;
            /* 减少控制按钮的底部边距 */
        }
        
        .btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #000;
            width: 20px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background-color: #f0f0f0;
        }
        
        .btn-play {
            width: 50px;
            height: 50px;
            background-color: #000;
            color: #fff;
            font-size: 18px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-bottom: 2px;
        }
        
        .btn-play:hover {
            background-color: #333;
            transform: scale(1.05);
        }
        
        .btn-loop {
            font-size: 18px;
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 20px; 
        }
    
        /* 文件上传区域 */
        .import-section {
            margin-top: 5px;
            /* 减少文件上传区域的上边距，使其更靠近控制按钮 */
            width: 100%;
            max-width: 100%;
        }
        
        .import-btn {
            width: 100%;
            padding: 10px;
            background: white;
            border: 2px solid #000;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            font-size: 14px;
        }
        
        .import-btn:hover {
            background: #f0f0f0;
        }
        
        .file-input {
            display: none;
        }
        
        .playlist {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            margin-top: 10px;
            border: 2px solid #000000; 
            font-size: 12px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .playlist::-webkit-scrollbar {
            display: none;
            width: 0;
            background: transparent;
        }
        
        .playlist-item {
            padding: 6px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .playlist-item:hover {
            background: #f9f9f9;
        }
        
        .playlist-item.active {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .song-duration {
            font-size: 10px;
            color: #666;
            margin-left: 8px;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .music-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .music-artist {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
        }
        
        /* 确保唱片是完美圆形 */
        .disc-container::before {
            content: "";
            display: block;
            padding-top: 100%;
        }
        
        .disc-container > * {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- 确认对话框 -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-content">
            <h3>确认删除</h3>
            <p>您确定要删除这条消息吗？此操作不可撤销。</p>
            <div class="confirm-buttons">
                <button id="confirm-delete-btn">确认删除</button>
                <button id="cancel-delete-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 导入确认对话框 -->
    <div class="confirm-dialog" id="import-confirm-dialog">
        <div class="confirm-content">
            <h3>导入聊天记录</h3>
            <p>导入聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要继续吗？</p>
            <div class="confirm-buttons">
                <button id="confirm-import-btn">确认导入</button>
                <button id="cancel-import-btn">取消</button>
            </div>     
        </div>
    </div>

    <!-- 恢复确认对话框 -->
    <div class="confirm-dialog" id="restore-confirm-dialog">
        <div class="confirm-content">
            <h3>恢复聊天记录</h3>
            <p id="restore-confirm-text">恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复吗？</p>
            <div class="confirm-buttons">
                <button id="confirm-restore-btn">确认恢复</button>
                <button id="cancel-restore-btn">取消</button>
            </div>     
        </div>
    </div>

    <div class="persona-modal" id="persona-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>人设管理</h3>
                <button class="close-modal" onclick="closePersonaModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="persona-tabs">
                    <button class="persona-tab active" onclick="switchPersonaTab('ai')">角色人设</button>
                    <button class="persona-tab" onclick="switchPersonaTab('user')">我的人设</button>
                </div>    
                
                <div class="persona-form-section active" id="ai-persona-section">
                    <div class="form-section">
                        <h4>角色人设</h4>
                        <div class="form-group">
                            <label for="ai-persona-name">姓名</label>
                            <input type="text" class="form-input" id="ai-persona-name" placeholder="输入姓名...">
                        </div>
                        <div class="form-group">
                            <label for="ai-persona-desc">人设描述</label>
                            <textarea class="form-input" id="ai-persona-desc" rows="3" placeholder="输入人设描述..."></textarea>
                        </div>    
                        <div class="persona-actions">
                            <button onclick="saveAIPersona()">保存角色人设</button>
                            <button onclick="loadAIPersona()">加载角色人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="ai-persona-preview">
                        <h5>人设预览：</h5>
                        <div id="ai-preview-content">暂无人设</div>
                    </div>
                </div>
                
                <div class="persona-form-section" id="user-persona-section">
                    <div class="form-section">
                        <h4>我的人设</h4>
                        <div class="form-group">
                            <label for="user-persona-name">我的姓名</label>
                            <input type="text" class="form-input" id="user-persona-name" placeholder="输入您的姓名...">
                        </div>   
                        <div class="form-group">
                            <label for="user-persona-desc">我的人设描述</label>
                            <textarea class="form-input" id="user-persona-desc" rows="3" placeholder="输入您的人设描述..."></textarea>
                        </div>
                        <div class="persona-actions">
                            <button onclick="saveUserPersona()">保存我的人设</button>
                            <button onclick="loadUserPersona()">加载我的人设</button>
                        </div>
                    </div>
                    
                    <div class="persona-preview" id="user-persona-preview">
                        <h5>我的人设预览：</h5>
                        <div id="user-preview-content">暂无我的人设</div>
                    </div>
                </div>
            </div>
        </div>
    </div>    

    <div class="phone-container">
        <div class="screen">
            <!-- 桌面界面 -->
            <div class="desktop-interface active" id="desktop-interface">
                <div class="desktop-time" id="desktop-time">--:--</div>
                <!-- 新增可编辑个性签名 -->
                <div class="desktop-signature" id="desktop-signature" contenteditable="true">点击编辑个性签名...</div>
                <div class="app-grid">
                    <!-- 第一行应用 -->
                    <div class="app-item" onclick="openApp('chat')">
                        <div class="app-icon">︎⊕</div>
                        <div class="app-label">聊天</div>
                    </div>
                    <div class="app-item" onclick="openApp('api')">
                        <div class="app-icon">ꕥ</div>
                        <div class="app-label">API</div>
                    </div>
                    <div class="app-item" onclick="openApp('style')">
                        <div class="app-icon">Θ︎</div>
                        <div class="app-label">美化</div>
                    </div>
                    
                    <!-- 第二行新增应用 -->
                    <div class="app-item" onclick="openApp('worldbook')">
                        <div class="app-icon">✧︎</div>
                        <div class="app-label">世界书</div>
                    </div>
                    <div class="app-item" onclick="openApp('presets')">
                        <div class="app-icon">∞</div>
                        <div class="app-label">预设</div>
                    </div>
                    <div class="app-item" onclick="openApp('music')">
                        <div class="app-icon">ʊ</div>
                        <div class="app-label">音乐</div>
                    </div>
                </div>
            </div>

            <!-- 聊天界面 -->
            <div class="interface chat-interface" id="chat-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>✤世纪 <span class="status-indicator" id="chat-status"></span></h1>
                    <button class="toggle-persona" onclick="openPersonaModal()">编辑人设</button>
                </div>
                
                <div class="scrollable-content">
                    <div class="chat-container">
                        <div class="chat-messages" id="chat-messages">
                            <!-- 消息将通过JavaScript动态加载 -->
                        </div>
                    </div>      
                    <div class="persona-section">
                        <h3>基础人设设置</h3>
                        <input type="text" class="persona-input" id="persona-input" placeholder="输入角色人设描述...">
                        <div class="persona-buttons">
                            <button onclick="savePersona()">保存人设</button>
                            <button onclick="editPersona()">编辑人设</button>
                            <button onclick="applyPersona()">应用人设</button>
                        </div>
                    </div>
                    
                    <!-- 新增聊天记录备份区域 -->
                    <div class="backup-section">
                        <h3>聊天记录备份</h3>
                        <div class="backup-buttons">
                            <button onclick="exportChatHistory()">导出聊天记录</button>
                            <button onclick="importChatHistory()">导入聊天记录</button>
                            <button onclick="backupToLocal()">备份到本地</button>
                            <button onclick="restoreFromLocal()">从本地恢复</button>
                        </div>
                        <div class="backup-status" id="backup-status"></div>
                        <div class="backup-info">
                            使用导出/导入功能可以在不同浏览器之间迁移聊天记录
                        </div>
                        <input type="file" class="backup-file-input" id="backup-file-input" accept=".json">
                    </div>
                    
                    <div class="scroll-hint" id="chat-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
                
                <!-- 消息发送条固定在底部 -->
                <div class="chat-input-container">
                    <div class="chat-input">
                        <input type="text" id="message-input" placeholder="输入您的消息..." onkeypress="handleMessageKeypress(event)">
                        <button onclick="sendMessage()" id="send-button">发送</button>
                    </div>
                </div>
                
                <!-- 聊天界面底部导航栏（已隐藏） -->
                <div class="app-navigation" style="display: none;"></div>
            </div>

            <!-- API配置界面 -->
            <div class="interface" id="api-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>API配置 <span class="status-indicator" id="api-status-indicator"></span></h1>
                </div>       
                <div class="scrollable-content">
                    <div class="api-section">
                        <h3>API提供商</h3>
                        <select class="api-input" id="api-provider" onchange="updateApiEndpoints()">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="custom">自定义</option>
                        </select>
                    </div>     
                    <div class="api-section">
                        <h3>API端点配置</h3>
                        <input type="text" class="api-input" id="api-url" placeholder="输入API端点URL..." value="https://api.openai.com/v1">
                        <input type="password" class="api-input" id="api-key" placeholder="输入API密钥...">
                        <div class="api-buttons">
                            <button onclick="testApiConnection()">测试API连接</button>
                            <button onclick="refreshModels()">刷新模型列表</button>
                            <button onclick="saveApiConfig()">保存配置</button>
                            <button onclick="clearApiConfig()">清除配置</button>   
                        </div>
                        <div class="api-status" id="api-status"></div>
                    </div>
                    <div class="api-section">
                        <h3>模型选择</h3>
                        <div class="model-info">
                            <span class="current-model" id="current-model-display">当前模型: 未选择</span>
                            <span class="model-badge" id="model-provider-badge">OpenAI</span>
                        </div>    
                        <select class="api-input" id="model-select" onchange="updateSelectedModel()">
                            <option value="">请选择模型</option>
                        </select>
                        <div class="refresh-status">
                            <button class="refresh-button" onclick="refreshModels()">刷新模型</button>
                            <span class="last-updated" id="last-updated">上次更新: 从未</span>
                        </div>
                        <div class="model-list" id="model-list" style="display: none;">
                            <div class="api-status" id="models-status"></div>
                        </div>
                    </div>    
                    <div class="api-section">
                        <h3>高级设置</h3>
                        <div class="form-group">
                            <label for="temperature">温度 (0-2)</label>
                            <input type="range" class="api-input" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="updateTemperatureValue()">
                            <span id="temperature-value">0.7</span>
                        </div>  
                        <div class="form-group">
                            <label for="max-tokens">最大令牌数</label>
                            <input type="number" class="api-input" id="max-tokens" value="1000" min="1" max="4000">
                        </div>
                    </div>
                    <div class="scroll-hint" id="api-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 美化界面 -->
            <div class="interface" id="style-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>CSS美化 <span class="status-indicator" id="style-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="style-container">
                        <div class="ai-circle">AI</div>
                        <textarea class="css-editor" id="css-editor" placeholder="输入全局CSS代码...">/* 在这里输入您的自定义CSS */
.message {     
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {
    margin-left: auto;
    background: #f8f8f8;
}    

.ai-message {
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {    
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}</textarea> 
                        <div class="style-buttons">
                            <button class="apply-css" onclick="applyGlobalCSS()">应用CSS</button>
                            <button class="apply-css" onclick="resetCSS()">重置CSS</button>
                            <button class="apply-css" onclick="exportCSS()">导出CSS</button>
                            <button class="apply-css" onclick="importCSS()">导入CSS</button>
                        </div>
                    </div>
                    <div class="scroll-hint" id="style-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 音乐界面 - 修复后的版本 -->
            <div class="interface" id="music-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>黑胶唱片 <span class="status-indicator" id="music-status"></span></h1>
                </div>
                <div class="scrollable-content">
                    <div class="music-player">
                        <!-- 固定区域 - 唱片、歌曲信息、进度条、控制按钮 -->
                        <div class="music-fixed-area">
                            <!-- 唱片区域 -->
                            <div class="disc-container">
                                <div class="disc" id="disc">
                                    <div class="disc-center"></div>
                                </div>
                            </div>
                            
                            <!-- 歌曲信息 -->
                            <div class="song-info">
                                <div class="song-title" id="song-title">选择音频开始播放</div>
                                <div class="song-artist" id="song-artist">-</div>
                            </div>
                            
                            <!-- 进度条 -->
                            <div class="progress-container">
                                <div class="progress-info">
                                    <span class="current-time" id="current-time">0:00</span>
                                    <span class="duration" id="duration">0:00</span>
                                </div>
                                <div class="progress-bar" id="progress-bar">
                                    <div class="progress" id="progress"></div>
                                </div>
                            </div>
                            
                            <!-- 控制按钮 - 修复：添加单曲循环按钮 -->
                            <div class="control-buttons">
                                <button class="btn btn-loop active" id="list-loop-btn" title="顺序播放">✦</button>
                                <button class="btn btn-prev" id="prev-btn">⏮</button>
                                <button class="btn btn-play" id="play-pause-btn">▶</button>
                                <button class="btn btn-next" id="next-btn">⏭</button>
                                <button class="btn btn-loop" id="single-loop-btn" title="单曲循环">✦</button>
                            </div>
                        </div>
                        
                        <!-- 可滚动区域 - 文件上传和播放列表 -->
                        <div class="music-scrollable-area">
                            <!-- 文件上传区域 -->
                            <div class="import-section">
                                <div class="import-btn" id="import-btn">
                                    选择音频文件
                                </div>
                                <input type="file" class="file-input" id="file-input" accept="audio/*" multiple>
                                
                                <div class="playlist" id="playlist">
                                    <div class="playlist-item empty">
                                        播放列表为空
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 其他界面保持不变 -->
            <!-- 世界书界面 -->
            <div class="interface" id="worldbook-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>世界书</h1>
                </div>
                <div class="scrollable-content">
                    <div style="padding: 20px; text-align: center;">
                        <h2>世界书功能</h2>
                        <p>这里将展示世界知识和信息</p>
                        <p>功能开发中...</p>
                    </div>
                    <div class="scroll-hint" id="worldbook-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>

            <!-- 预设界面 -->
            <div class="interface" id="presets-interface">
                <div class="header">
                    <button class="back-button" onclick="goBackToDesktop()">●</button>
                    <h1>预设</h1>
                </div>
                <div class="scrollable-content">
                    <div style="padding: 20px; text-align: center;">
                        <h2>预设功能</h2>
                        <p>这里可以管理和应用各种预设</p>
                        <p>功能开发中...</p>
                    </div>
                    <div class="scroll-hint" id="presets-scroll-hint">↑ 继续向上滑动查看更多内容</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 音乐播放器功能 - 修复后的版本
        const musicPlayer = {
            audio: new Audio(),
            playlist: [],
            currentIndex: -1,
            isPlaying: false,
            loopMode: 'list', // 默认顺序播放
          
            init: function() {
                // 绑定事件
                this.bindEvents();
                
                // 音频事件监听
                this.audio.addEventListener('loadedmetadata', () => {
                    this.updateTotalTime();
                });
                
                this.audio.addEventListener('timeupdate', () => {
                    this.updateProgress();
                });
                
                // 修复：移除重复的ended事件监听，合并为一个
                this.audio.addEventListener('ended', () => {
                    if (this.loopMode === 'single') {
                        this.audio.currentTime = 0;
                        this.audio.play();
                    } else {    
                        this.next();
                    }
                });
             
                // 初始化音乐状态指示灯
                this.updateMusicStatusIndicator();
                
                // 初始化循环模式
                this.setLoopMode('list');
            },
            
            bindEvents: function() {
                // 播放/暂停按钮
                document.getElementById('play-pause-btn').addEventListener('click', () => {
                    this.togglePlay();
                });
                
                // 上一首按钮
                document.getElementById('prev-btn').addEventListener('click', () => {
                    this.prev();
                });
                
                // 下一首按钮
                document.getElementById('next-btn').addEventListener('click', () => {
                    this.next();
                });
                
                // 进度条点击
                document.getElementById('progress-bar').addEventListener('click', (e) => {
                    this.seek(e);
                });
                
                // 导入按钮
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('file-input').click();
                });
                
                // 单曲循环按钮事件
                document.getElementById('single-loop-btn').addEventListener('click', () => {
                    this.setLoopMode('single');
                });

                // 顺序播放按钮事件  
                document.getElementById('list-loop-btn').addEventListener('click', () => {
                    this.setLoopMode('list');
                });
              
                // 文件选择
                document.getElementById('file-input').addEventListener('change', (e) => {
                    this.handleFileSelect(e);
                });
            },
            
            handleFileSelect: function(e) {
                const files = e.target.files;
                if (files.length === 0) return;
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('audio/')) {
                        const url = URL.createObjectURL(file);
                        this.addToPlaylist(file.name, url, file);
                    }
                }
                
                // 如果当前没有播放音乐，自动播放第一首
                if (this.currentIndex === -1 && this.playlist.length > 0) {
                    this.play(0);
                }
                
                // 清空文件输入，以便再次选择相同文件
                e.target.value = '';
            },
            
            addToPlaylist: function(name, url, file) {
                const playlist = document.getElementById('playlist');
                
                // 移除空列表提示
                if (playlist.querySelector('.empty')) {
                    playlist.innerHTML = '';
                }
                
                // 创建播放列表项
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.url = url;
                
                // 获取音频时长
                const tempAudio = new Audio(url);
                tempAudio.addEventListener('loadedmetadata', () => {
                    const duration = this.formatTime(tempAudio.duration);
                    item.innerHTML = `
                        <div class="song-title">${name}</div>
                        <div class="song-duration">${duration}</div>
                    `;
                    
                    // 保存时长信息
                    item.dataset.duration = tempAudio.duration;
                });
                
                // 点击播放
                item.addEventListener('click', () => {
                    const index = Array.from(playlist.children).indexOf(item);
                    this.play(index);
                });
                
                playlist.appendChild(item);
                
                // 添加到内部播放列表
                this.playlist.push({
                    name: name,
                    url: url,
                    file: file
                });
            },
            
            play: function(index) {
                if (index < 0 || index >= this.playlist.length) return;
                
                this.currentIndex = index;
                const song = this.playlist[index];
                
                // 更新音频源
                this.audio.src = song.url;
                
                // 更新UI
                document.getElementById('song-title').textContent = song.name;
                document.getElementById('song-artist').textContent = '本地音乐';
                
                // 高亮当前播放项
                const playlistItems = document.querySelectorAll('.playlist-item');
                playlistItems.forEach(item => item.classList.remove('active'));
                playlistItems[index].classList.add('active');
                
                // 播放
                this.audio.play();
                this.isPlaying = true;
                this.updatePlayState();
            },
            
            togglePlay: function() {
                if (this.currentIndex === -1) {
                    if (this.playlist.length > 0) {
                        this.play(0);
                    }
                    return;
                }
                
                if (this.isPlaying) {
                    this.audio.pause();
                } else {
                    this.audio.play();
                }
                
                this.isPlaying = !this.isPlaying;
                this.updatePlayState();
            },
            
            updatePlayState: function() {
                const disc = document.getElementById('disc');
                const playPauseIcon = document.getElementById('play-pause-btn');
                
                if (this.isPlaying) {
                    disc.classList.add('playing');
                    playPauseIcon.textContent = '❚❚';
                } else {
                    disc.classList.remove('playing');
                    playPauseIcon.textContent = '▶';
                }
                
                // 更新音乐状态指示灯
                this.updateMusicStatusIndicator();
            },
            
            updateMusicStatusIndicator: function() {
                const musicStatus = document.getElementById('music-status');
                if (this.isPlaying) {
                    musicStatus.className = 'status-indicator status-online';
                    musicStatus.title = '正在播放';
                } else {
                    musicStatus.className = 'status-indicator status-offline';
                    musicStatus.title = '未播放';
                }
            },
            
            prev: function() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentIndex - 1;
                if (newIndex < 0) {
                    newIndex = this.playlist.length - 1;
                }
                
                this.play(newIndex);
            },
            
            next: function() {
                if (this.playlist.length === 0) return;
                
                let newIndex = this.currentIndex + 1;
                if (newIndex >= this.playlist.length) {
                    newIndex = 0;
                }
                
                this.play(newIndex);
            },
            
            seek: function(e) {
                if (this.currentIndex === -1) return;
                
                const progressBar = document.getElementById('progress-bar');
                const rect = progressBar.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                
                this.audio.currentTime = percent * this.audio.duration;
            },
            
            updateProgress: function() {
                const progress = document.getElementById('progress');
                const currentTime = document.getElementById('current-time');
                
                if (this.audio.duration) {
                    const percent = (this.audio.currentTime / this.audio.duration) * 100;
                    progress.style.width = `${percent}%`;
                    
                    currentTime.textContent = this.formatTime(this.audio.currentTime);
                }
            },
            
            updateTotalTime: function() {
                const duration = document.getElementById('duration');
                duration.textContent = this.formatTime(this.audio.duration);
            },
            
            formatTime: function(seconds) {
                if (isNaN(seconds)) return '0:00';
                
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            },
            
            setLoopMode: function(mode) {
                const singleBtn = document.getElementById('single-loop-btn');
                const listBtn = document.getElementById('list-loop-btn');
                  
                singleBtn.classList.remove('active');
                listBtn.classList.remove('active');
                  
                this.loopMode = mode;
                 
                if (mode === 'single') {
                    singleBtn.classList.add('active');
                } else {
                    listBtn.classList.add('active');
                }
            }
        };

        // 个性签名管理
        function saveSignature() {
            const signature = document.getElementById('desktop-signature').textContent;
            localStorage.setItem('desktopSignature', signature);
        }

        function loadSignature() {
            const savedSignature = localStorage.getItem('desktopSignature');
            if (savedSignature) {
                document.getElementById('desktop-signature').textContent = savedSignature;
            }
        }

        // 完整的聊天记录管理类，包含监听功能
        class ChatManager {
            constructor() {
                 this.messages = JSON.parse(localStorage.getItem('chatMessages')) || [];
                 this.currentEditingId = null;
                 this.listeners = []; // 监听器数组
        
                 // 代理messages数组以实现监听
                 this.messages = this.createObservableArray(this.messages);
            }           

            // 修复 createObservableArray 方法
            createObservableArray(array) {
                const self = this;
                return new Proxy(array, {
                    set(target, property, value) {
                        const result = Reflect.set(target, property, value);
                        // 触发变化监听
                         self.notifyListeners('messagesChanged', target);
                         self.saveMessages();
                         return result;
                    },
                   // 添加对数组方法的监听
                   get(target, property) {
                       const value = Reflect.get(target, property);
                       if (typeof value === 'function') {
                           return function(...args) {
                               const result = value.apply(target, args);
                               // 当调用 push, splice 等方法时触发监听
                               if (['push', 'pop', 'shift', 'unshift', 'splice'].includes(property)) {
                                  self.notifyListeners('messagesChanged', target);
                                  self.saveMessages();
                               }
                               return result;
                           };
                       }
                       return value;
                   }
               });
            }

            // 添加监听器
            addListener(event, callback) {
                 this.listeners.push({ event, callback });
            }

            // 通知监听器
            notifyListeners(event, data) {
                this.listeners.forEach(listener => {
                    if (listener.event === event) {
                        listener.callback(data);
                    }
                });
            }

            saveMessages() {
                 localStorage.setItem('chatMessages', JSON.stringify(this.messages));
            }
            
            addMessage(sender, content, type = 'text') {
                 const message = {
                      id: Date.now() + Math.random().toString(36).substr(2, 9),
                      sender: sender,
                      content: content,
                      type: type,
                      timestamp: new Date().toISOString()
                 };
                 this.messages.push(message);
                 // saveMessages() 会通过代理自动调用
                 return message;     
            }
            
            updateMessage(id, newContent) {
                 const message = this.messages.find(msg => msg.id === id);
                 if (message) {
                     message.content = newContent;
                     message.timestamp = new Date().toISOString();
                     this.saveMessages();
                     this.notifyListeners('messageUpdated', message); // 手动触发更新事件
                     return true;
                 }
                 return false;
            }
            
            deleteMessage(id) {
                const index = this.messages.findIndex(msg => msg.id === id);
                if (index !== -1) {   
                    const deletedMessage = this.messages[index];
                    this.messages.splice(index, 1);
                    // 保存到 localStorage
                    this.saveMessages();
                    this.notifyListeners('messageDeleted', deletedMessage);
                    return true;
                }
                return false;
            }

            getMessages() {
                 return [...this.messages];
            }
        }
        
        // API服务类
        class ApiService {
            constructor() {    
                this.config = JSON.parse(localStorage.getItem('apiConfig')) || {
                    provider: 'openai',
                    apiKey: '',
                    apiUrl: 'https://api.openai.com/v1',
                    model: 'gpt-3.5-turbo'
                };
            }             

            async getModels() {
                try {
                    const response = await fetch(`${this.config.apiUrl}/models`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });  
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.data.map(model => model.id);
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    throw error;
                }
            }      

            async chatWithRole(rolePrompt, userMessage, temperature = 0.7) {
                if (!this.config.apiKey) {
                    throw new Error('API密钥未配置');
                }   

                // 获取AI人设和用户人设
                const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
                
                // 构建完整的系统提示
                let systemPrompt = rolePrompt;
                
                // 添加角色人设信息
                if (aiPersona.name || aiPersona.description) {
                    systemPrompt += `\n\nAI角色信息：`;
                    if (aiPersona.name) systemPrompt += `\n- 姓名：${aiPersona.name}`;
                    if (aiPersona.description) systemPrompt += `\n- 描述：${aiPersona.description}`;
                }   
                
                // 添加用户人设信息
                if (userPersona.name || userPersona.description) {
                    systemPrompt += `\n\n用户信息：`;
                    if (userPersona.name) systemPrompt += `\n- 姓名：${userPersona.name}`;
                    if (userPersona.description) systemPrompt += `\n- 描述：${userPersona.description}`;
                }

                // 获取最近9条消息作为上下文（排除当前消息）
                const allMessages = appState.chatManager.getMessages();
                // 过滤掉当前正在生成的消息，取最后9条（为当前消息留出位置）
                const recentMessages = allMessages
                    .filter(msg => msg.content !== '正在思考...' && msg.content !== userMessage)
                    .slice(-9);

                // 构建消息数组 - 包含系统提示、历史上下文
                const messages = [
                    { role: 'system', content: systemPrompt }
                ];
                
                // 添加历史消息到上下文
                recentMessages.forEach(msg => {
                    if (msg.sender === 'user') {
                        messages.push({ role: 'user', content: msg.content });
                    } else {
                        messages.push({ role: 'assistant', content: msg.content });
                    }
                });

                // 添加当前用户消息（确保不会重复）
                messages.push({ role: 'user', content: userMessage });

                console.log('发送到API的消息上下文:', messages);

                try {   
                    const response = await fetch(`${this.config.apiUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.config.apiKey}`,
                            'Content-Type': 'application/json'
                        },     
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: messages,
                            temperature: temperature,
                            max_tokens: parseInt(document.getElementById('max-tokens').value) || 1000
                        })
                    });      

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API请求失败: ${errorData.error?.message || response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API调用失败:', error);
                    throw error;
                }
            }  

            async testConnection() {
                try {
                    const models = await this.getModels();
                    return { success: true, models: models };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            updateConfig(newConfig) {
                this.config = { ...this.config, ...newConfig };
                localStorage.setItem('apiConfig', JSON.stringify(this.config));
            }    

            getCurrentConfig() {
                return { ...this.config };
            }
        }

        // 全局状态
        const appState = {
            currentPersona: null,
            apiConfig: {},
            customCSS: '',
            isGenerating: false,
            models: [],
            lastUpdated: null,
            apiService: new ApiService(),
            chatManager: new ChatManager(),
            currentPersonaTab: 'ai',
            currentEditingMessageId: null
        };  

        const API_ENDPOINTS = {
            openai: 'https://api.openai.com/v1',
            anthropic: 'https://api.anthropic.com/v1',
            google: 'https://generativelanguage.googleapis.com/v1'
        };

        const MODEL_LISTS = {
            openai: ['gpt-4', 'gpt-4-turbo', 'gpt-3.5-turbo', 'gpt-3.5-turbo-16k'],
            anthropic: ['claude-3-opus', 'claude-3-sonnet', 'claude-3-haiku'],
            google: ['gemini-pro', 'gemini-pro-vision']
        };

        let currentInterface = 'desktop'; // 初始化为桌面
        let deleteMessageId = null;
        
        // 修复监听器 - 确保消息更新时重新渲染
        appState.chatManager.addListener('messagesChanged', (messages) => {
            console.log('消息列表发生变化:', messages);
            renderChatMessages();
        });

        appState.chatManager.addListener('messageUpdated', (message) => {
            console.log('消息被更新:', message);
            renderChatMessages(); // 确保界面更新
        });

        appState.chatManager.addListener('messageDeleted', (message) => {
            console.log('消息被删除:', message);
            renderChatMessages(); // 确保界面更新
        });

        // 新增功能函数
        function updateDesktopTime() {
            const now = new Date();
            const timeElement = document.getElementById('desktop-time');
            
            // 格式化时间
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            timeElement.textContent = `${hours}:${minutes}`;
        }

        function openApp(appName) {
            // 隐藏桌面
            document.getElementById('desktop-interface').classList.remove('active');
            
            // 显示对应的应用界面
            const interface = document.getElementById(`${appName}-interface`);
            interface.classList.add('active');
            
            // 更新当前界面状态
            currentInterface = appName;
            
            // 更新状态指示器
            updateStatusIndicators();
        }

        function goBackToDesktop() {
            // 隐藏所有应用界面
            document.querySelectorAll('.interface').forEach(interface => {
                interface.classList.remove('active');
            });
            
            // 显示桌面
            document.getElementById('desktop-interface').classList.add('active');
            
            // 重置当前界面状态
            currentInterface = 'desktop';
        }

        // 删除相关函数
        function showDeleteConfirm(messageId) {
            deleteMessageId = messageId;
            document.getElementById('confirm-dialog').style.display = 'flex';
        }

        function confirmDelete() {
            if (!deleteMessageId) {
                document.getElementById('confirm-dialog').style.display = 'none';
                return;
            }

            console.log('确认删除消息ID:', deleteMessageId);

            // 执行删除操作
            const success = appState.chatManager.deleteMessage(deleteMessageId);
            console.log('删除结果:', success);

            // 重新渲染界面
            renderChatMessages();

            // 隐藏对话框
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function cancelDelete() {
            document.getElementById('confirm-dialog').style.display = 'none';
            deleteMessageId = null;
        }

        function openPersonaModal() {
            document.getElementById('persona-modal').style.display = 'flex';
            loadPersonaPreviews();
        }

        function closePersonaModal() {
            document.getElementById('persona-modal').style.display = 'none';
        }

        function switchPersonaTab(tabName) {
            document.querySelectorAll('.persona-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.persona-form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelector(`.persona-tab[onclick="switchPersonaTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-persona-section`).classList.add('active');
            
            appState.currentPersonaTab = tabName;
            loadPersonaPreviews();
        }     

        function loadPersonaPreviews() {
            const aiPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            const userPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            
            if (aiPersona.name || aiPersona.description) {
                document.getElementById('ai-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${aiPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${aiPersona.description || '未设置'}
                `;
            } else {   
                document.getElementById('ai-preview-content').textContent = '暂无角色人设';
            }
            
            if (userPersona.name || userPersona.description) {
                document.getElementById('user-preview-content').innerHTML = `
                    <strong>姓名:</strong> ${userPersona.name || '未设置'}<br>
                    <strong>描述:</strong> ${userPersona.description || '未设置'}
                `;
            } else {
                document.getElementById('user-preview-content').textContent = '暂无我的人设';
            }
        }   

        function saveAIPersona() {
            const name = document.getElementById('ai-persona-name').value.trim();
            const desc = document.getElementById('ai-persona-desc').value.trim();
            
            const persona = {
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };     
            
            localStorage.setItem('aiPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            
            // 新增：保存后重新渲染聊天消息，以更新AI名称显示
            renderChatMessages();
            
            alert('角色人设保存成功！');
        }

        function loadAIPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
            document.getElementById('ai-persona-name').value = savedPersona.name || '';
            document.getElementById('ai-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            
            // 新增：加载后重新渲染聊天消息
            renderChatMessages();
            
            alert('角色人设加载成功！');
        }

        function saveUserPersona() {
            const name = document.getElementById('user-persona-name').value.trim();
            const desc = document.getElementById('user-persona-desc').value.trim();
            
            const persona = {    
                name: name,
                description: desc,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('userPersona', JSON.stringify(persona));
            loadPersonaPreviews();
            
            // 新增：保存后重新渲染聊天消息
            renderChatMessages();
            
            alert('我的人设保存成功！');
        }

        function loadUserPersona() {
            const savedPersona = JSON.parse(localStorage.getItem('userPersona') || '{}');
            document.getElementById('user-persona-name').value = savedPersona.name || '';
            document.getElementById('user-persona-desc').value = savedPersona.description || '';
            loadPersonaPreviews();
            
            // 新增：加载后重新渲染聊天消息
            renderChatMessages();
            
            alert('我的人设加载成功！');
        }   

        function editMessage(button, messageId) {
            const messageElement = button.closest('.message');
            const contentElement = messageElement.querySelector('.message-content');
            const currentContent = contentElement.textContent;
            
            // 进入编辑模式
            messageElement.classList.add('editing');
            contentElement.innerHTML = `
                <textarea class="edit-input">${currentContent}</textarea>
                <div class="edit-actions">
                    <button onclick="saveEdit('${messageId}')">保存</button>
                    <button onclick="cancelEdit('${messageId}')">取消</button>
                </div>
            `;
            
            appState.currentEditingMessageId = messageId;
        }

        function saveEdit(messageId) {    
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            const textarea = messageElement.querySelector('.edit-input');
            const newContent = textarea.value.trim();
            
            if (newContent) {
                // 更新消息内容
                if (appState.chatManager.updateMessage(messageId, newContent)) {
                    messageElement.classList.remove('editing');
                    messageElement.querySelector('.message-content').innerHTML = newContent;
                }
            }
            
            appState.currentEditingMessageId = null;
        }    

        function cancelEdit(messageId) {
            const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
            messageElement.classList.remove('editing');
            
            // 恢复原始内容
            const message = appState.chatManager.messages.find(msg => msg.id === messageId);
            if (message) {
                messageElement.querySelector('.message-content').innerHTML = message.content;
            }
            
            appState.currentEditingMessageId = null;
        }

        function updateStatusIndicators() {
            const chatStatus = document.getElementById('chat-status');
            const apiStatus = document.getElementById('api-status-indicator');
            const styleStatus = document.getElementById('style-status');
            const musicStatus = document.getElementById('music-status');
            
            // 聊天状态指示灯 - 根据生成状态变化
            if (appState.isGenerating) {
                chatStatus.className = 'status-indicator status-generating';
                chatStatus.title = '正在生成回复...';
            } else {
                if (appState.currentPersona) {
                    chatStatus.className = 'status-indicator status-online';
                    chatStatus.title = '人设已应用';
                } else {
                    chatStatus.className = 'status-indicator status-offline';
                    chatStatus.title = '使用默认人设';
                }
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey && currentConfig.model) {
                apiStatus.className = 'status-indicator status-online';
                apiStatus.title = 'API配置完成';
            } else {
                apiStatus.className = 'status-indicator status-offline';
                apiStatus.title = 'API未配置';
            }    
            
            if (appState.customCSS) {
                styleStatus.className = 'status-indicator status-online';
                styleStatus.title = '自定义样式已应用';
            } else {
                styleStatus.className = 'status-indicator status-offline';
                styleStatus.title = '使用默认样式';
            }
            
            // 音乐状态指示灯
            if (musicPlayer.isPlaying) {
                musicStatus.className = 'status-indicator status-online';
                musicStatus.title = '正在播放';
            } else {
                musicStatus.className = 'status-indicator status-offline';
                musicStatus.title = '未播放';
            }
        }

        function handleMessageKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function renderChatMessages() {
            const chatMessages = document.getElementById('chat-messages');
            const messages = appState.chatManager.getMessages();
            
            console.log('渲染消息列表，消息数量:', messages.length);
             console.log('消息内容:', messages);
            
            chatMessages.innerHTML = '';      
            
            messages.forEach(message => {
                const messageElement = document.createElement('div');
                const isUser = message.sender === 'user';
                const aiName = getCurrentAiName();
                const userName = getCurrentUserName(); // 获取用户人设名称
                
                messageElement.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
                messageElement.setAttribute('data-message-id', message.id);
                
                messageElement.innerHTML = `
                    <div class="message-sender">${isUser ? userName : aiName}</div>
                    <div class="message-content">${message.content}</div>
                    <div class="message-actions">
                        <button class="message-action" title="编辑" onclick="editMessage(this, '${message.id}')">✤</button>
                        <button class="message-action" title="删除" onclick="showDeleteConfirm('${message.id}')">✖</button>
                    </div>    
                `;
                
                chatMessages.appendChild(messageElement);
            });
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function getCurrentAiName() {
            // 从保存的AI人设中获取名称
            const savedPersona = localStorage.getItem('aiPersona');
             if (savedPersona) {
                 try {
                     const persona = JSON.parse(savedPersona);
                     // 如果设置了AI名称，则返回名称，否则返回默认名称
                      return persona.name || 'AI助手';
                 } catch (e) {
                     console.error('解析AI人设失败:', e);
                     return 'AI助手';
                 }
             }
            // 如果没有保存的人设，返回默认名称
            return 'AI助手';
        }

        function getCurrentUserName() {
            // 从保存的用户人设中获取名称
            const savedPersona = localStorage.getItem('userPersona');
            if (savedPersona) {
                try {
                    const persona = JSON.parse(savedPersona);
                    // 如果设置了用户名称，则返回名称，否则返回默认名称
                    return persona.name || '您';
                } catch (e) {
                    console.error('解析用户人设失败:', e);
                    return '您';
                }
            }
            // 如果没有保存的人设，返回默认名称
            return '您';
        }

        async function sendMessage() {
            if (appState.isGenerating) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message) return;
            
            const sendButton = document.getElementById('send-button');
            
            // 先清空输入框，防止重复发送
            input.value = '';
            appState.isGenerating = true;
            sendButton.disabled = true;  
            sendButton.textContent = '生成中...';
            
            // 更新状态指示灯为绿色
            updateStatusIndicators();
            
            // 添加用户消息
            appState.chatManager.addMessage('user', message);
            renderChatMessages();
            
            // 添加思考消息
            const thinkingMessage = appState.chatManager.addMessage('ai', '正在思考...');
            renderChatMessages();
            
            try {
                const rolePrompt = getCurrentRolePrompt();
                const temperature = parseFloat(document.getElementById('temperature').value) || 0.7;
                const response = await appState.apiService.chatWithRole(rolePrompt, message, temperature);
                
                // 更新角色回复    
                appState.chatManager.updateMessage(thinkingMessage.id, response);
                renderChatMessages();
                
            } catch (error) {
                // 更新错误消息       
                appState.chatManager.updateMessage(thinkingMessage.id, `抱歉，生成回复时出现错误：${error.message}`);
                renderChatMessages();
                
                console.error('API调用错误:', error);
            } finally {
                appState.isGenerating = false;
                sendButton.disabled = false;
                sendButton.textContent = '发送';
                
                // 恢复状态指示灯
                updateStatusIndicators();
            }
        }

        function getCurrentRolePrompt() {
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {    
                const persona = JSON.parse(savedPersona);
                return persona.description || '你是一个有用的AI助手';
            }
            
            const basicPersona = document.getElementById('persona-input').value;
            return basicPersona || '你是一个有用的AI助手';
        }

        function updateApiEndpoints() {  
            const provider = document.getElementById('api-provider').value;
            const endpointInput = document.getElementById('api-url');
            const modelSelect = document.getElementById('model-select');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (provider !== 'custom') {
                endpointInput.value = API_ENDPOINTS[provider] || '';
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
                modelSelect.innerHTML = '<option value="">请选择模型</option>';
                const models = MODEL_LISTS[provider] || [];
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            }
        }

        function updateSelectedModel() {
            const modelSelect = document.getElementById('model-select');
            const currentModelDisplay = document.getElementById('current-model-display');
            const selectedModel = modelSelect.value;
            
            if (selectedModel) {
                currentModelDisplay.textContent = `当前模型: ${selectedModel}`;
                appState.apiService.updateConfig({ model: selectedModel });
            } else {
                currentModelDisplay.textContent = '当前模型: 未选择';
                appState.apiService.updateConfig({ model: '' });
            }
        }

        async function testApiConnection() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            
            if (!apiKey) {    
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '测试连接中...';
            
            try {     
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });
                
                const result = await appState.apiService.testConnection();
                
                if (result.success) {
                    statusDiv.className = 'api-status status-success';
                    statusDiv.textContent = '✔ API连接成功！';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ API连接失败: ${error.message}`;
            }   
            
            updateStatusIndicators();
        }

        async function refreshModels() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const provider = document.getElementById('api-provider').value;
            const statusDiv = document.getElementById('api-status');
            const lastUpdated = document.getElementById('last-updated');
            const providerBadge = document.getElementById('model-provider-badge');
            
            if (!apiKey) { 
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = '✖ 请先输入API密钥';
                return;
            }
            
            statusDiv.style.display = 'block';
            statusDiv.className = 'api-status';
            statusDiv.textContent = '获取模型中...';
            
            try {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl
                });    
                
                const models = await appState.apiService.getModels();
                updateModelSelect(models);
                statusDiv.className = 'api-status status-success';
                statusDiv.textContent = `✔ 成功获取 ${models.length} 个模型`;
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
                
            } catch (error) {
                statusDiv.className = 'api-status status-error';
                statusDiv.textContent = `✖ 获取模型失败: ${error.message}`;
                
                const models = MODEL_LISTS[provider] || ['default-model'];
                updateModelSelect(models);
                appState.models = models;
                appState.lastUpdated = new Date();
                lastUpdated.textContent = `上次更新: ${appState.lastUpdated.toLocaleTimeString()}`;
                updateSelectedModel();   
                providerBadge.textContent = provider.charAt(0).toUpperCase() + provider.slice(1);
            }
        }

        function updateModelSelect(models) {
            const modelSelect = document.getElementById('model-select');
            
            modelSelect.innerHTML = '<option value="">请选择模型</option>';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
        }   

        function saveApiConfig() {  
            const apiKey = document.getElementById('api-key').value;
            const apiUrl = document.getElementById('api-url').value;
            const model = document.getElementById('model-select').value;
            const provider = document.getElementById('api-provider').value;
            const temperature = document.getElementById('temperature').value;
            const maxTokens = document.getElementById('max-tokens').value;
            
            if (apiKey && model) {
                appState.apiService.updateConfig({
                    provider: provider,
                    apiKey: apiKey,
                    apiUrl: apiUrl,
                    model: model
                });      
                
                updateStatusIndicators();
                alert('API配置保存成功！');
            } else {
                alert('请填写完整的API配置信息。');
            }
        }

        function clearApiConfig() {
            document.getElementById('api-key').value = '';
            document.getElementById('api-url').value = 'https://api.openai.com/v1';
            document.getElementById('model-select').innerHTML = '<option value="">请选择模型</option>';
            document.getElementById('api-provider').value = 'openai';
            document.getElementById('temperature').value = '0.7';
            document.getElementById('max-tokens').value = '1000';
            document.getElementById('current-model-display').textContent = '当前模型: 未选择';
            
            appState.apiService.updateConfig({
                provider: 'openai',      
                apiKey: '',
                apiUrl: 'https://api.openai.com/v1',
                model: ''
            });
            
            updateStatusIndicators();  
            alert('API配置已清除！');
        }

        function applyGlobalCSS() {
            const cssCode = document.getElementById('css-editor').value;
            let styleElement = document.getElementById('global-css');
            
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'global-css';
                document.head.appendChild(styleElement);
            }    
            
            styleElement.textContent = cssCode;
            appState.customCSS = cssCode;
            localStorage.setItem('customCSS', cssCode);
            updateStatusIndicators();
            alert('全局CSS应用成功！');
        }

        function resetCSS() {
            document.getElementById('css-editor').value = `/* 在这里输入您的自定义CSS */
.message {
    border: 1px solid #000;
    background: white;
    margin: 8px 0;
    max-width: 85%;
}

.user-message {   
    margin-left: auto;
    background: #f8f8f8;
}

.ai-message {  
    margin-right: auto;
    background: #f0f0f0;
}

.ai-circle {
    border: 3px solid #000;
    background: white;
    transition: all 0.3s ease;
}

.ai-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}`;     
            appState.customCSS = '';
            localStorage.removeItem('customCSS');
            
            const styleElement = document.getElementById('global-css');
            if (styleElement) {
                styleElement.remove();
            }
            
            updateStatusIndicators();
            alert('CSS已重置为默认值！');
        }     

        function exportCSS() {
            const cssCode = document.getElementById('css-editor').value;
            const blob = new Blob([cssCode], { type: 'text/css' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;    
            a.download = 'ai_app_styles.css';
            a.click();
            URL.revokeObjectURL(url);
            alert('CSS代码已导出！');
        }

        function importCSS() {    
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.css';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('css-editor').value = e.target.result;
                    alert('CSS代码已导入！');
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function updateTemperatureValue() {
            const temperature = document.getElementById('temperature');
            const valueSpan = document.getElementById('temperature-value');
            valueSpan.textContent = temperature.value;
        }

        function savePersona() {
            const personaInput = document.getElementById('persona-input');
            const persona = personaInput.value.trim();
            if (persona) {
                // 修改：保存时要包含名称信息
                const savedPersona = JSON.parse(localStorage.getItem('aiPersona') || '{}');
                const updatedPersona = {
                    ...savedPersona,
                    description: persona
                    // 如果没有设置名称，可以给一个默认名称
                    // name: savedPersona.name || 'AI助手'
                };
                localStorage.setItem('aiPersona', JSON.stringify(updatedPersona));
                
                // 新增：重新渲染聊天消息
                renderChatMessages();
                
                alert('人设保存成功！');
            }
        }       

        function editPersona() {  
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';
                alert('已加载保存的人设，您可以进行编辑。');
            }
        }

        function applyPersona() {
            const persona = localStorage.getItem('aiPersona');
            if (persona) {
                // 新增：应用人设时重新渲染
                renderChatMessages();
                alert('人设应用成功！当前对话将使用新的人设。');
            } else {
                alert('请先保存人设再应用。');
            }
        }

        // ==================== 聊天记录备份功能 ====================
        
        // 导出聊天记录为JSON文件
        function exportChatHistory() {
            const messages = appState.chatManager.getMessages();
            
            if (messages.length === 0) {
                showBackupStatus('没有聊天记录可以导出', 'error');
                return;
            }
            
            // 添加导出时间戳
            const exportData = {
                version: '1.0',
                exportTime: new Date().toISOString(),
                messageCount: messages.length,
                messages: messages
            };
            
            // 创建JSON文件并下载
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `chat_history_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showBackupStatus(`成功导出 ${messages.length} 条聊天记录`, 'success');
        }
        
        // 导入聊天记录
        function importChatHistory() {
            document.getElementById('backup-file-input').click();
        }
        
        // 处理文件选择
        document.getElementById('backup-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // 验证文件格式
                    if (!importData.messages || !Array.isArray(importData.messages)) {
                        showBackupStatus('文件格式不正确', 'error');
                        return;
                    }
                    
                    // 显示确认对话框
                    showImportConfirm(importData);
                } catch (error) {
                    console.error('解析文件失败:', error);
                    showBackupStatus('文件解析失败，请检查文件格式', 'error');
                }
            };
            reader.readAsText(file);
            
            // 清空文件输入，以便再次选择相同文件
            e.target.value = '';
        });
        
        // 显示导入确认对话框
        function showImportConfirm(importData) {
            document.getElementById('import-confirm-dialog').style.display = 'flex';
            
            // 绑定确认按钮事件
            document.getElementById('confirm-import-btn').onclick = function() {
                performImport(importData);
                document.getElementById('import-confirm-dialog').style.display = 'none';
            };
            
            // 绑定取消按钮事件
            document.getElementById('cancel-import-btn').onclick = function() {
                document.getElementById('import-confirm-dialog').style.display = 'none';
            };
        }
        
        // 执行导入操作
        function performImport(importData) {
            try {
                // 清空当前聊天记录
                appState.chatManager.messages.length = 0;
                
                // 导入消息
                importData.messages.forEach(msg => {
                    appState.chatManager.messages.push(msg);
                });
                
                // 保存到本地存储
                appState.chatManager.saveMessages();
                
                // 重新渲染聊天界面
                renderChatMessages();
                
                showBackupStatus(`成功导入 ${importData.messages.length} 条聊天记录`, 'success');
            } catch (error) {
                console.error('导入聊天记录失败:', error);
                showBackupStatus('导入聊天记录失败', 'error');
            }
        }
        
        // 备份到本地存储
        function backupToLocal() {
            const messages = appState.chatManager.getMessages();
            
            if (messages.length === 0) {
                showBackupStatus('没有聊天记录可以备份', 'error');
                return;
            }
            
            // 创建备份数据
            const backupData = {
                version: '1.0',
                backupTime: new Date().toISOString(),
                messageCount: messages.length,
                messages: messages
            };
            
            // 保存到本地存储
            localStorage.setItem('chatBackup', JSON.stringify(backupData));
            
            showBackupStatus(`成功备份 ${messages.length} 条聊天记录到本地`, 'success');
        }
        
        // 从本地存储恢复备份
        function restoreFromLocal() {
            const backupDataStr = localStorage.getItem('chatBackup');
            
            if (!backupDataStr) {
                showBackupStatus('没有找到本地备份', 'error');
                return;
            }
            
            try {
                const backupData = JSON.parse(backupDataStr);
                
                // 验证备份数据
                if (!backupData.messages || !Array.isArray(backupData.messages)) {
                    showBackupStatus('备份数据格式不正确', 'error');
                    return;
                }
                
                // 显示确认对话框
                showRestoreConfirm(backupData);
            } catch (error) {
                console.error('解析备份数据失败:', error);
                showBackupStatus('备份数据解析失败', 'error');
            }
        }
        
        // 显示恢复确认对话框
        function showRestoreConfirm(backupData) {
            document.getElementById('restore-confirm-dialog').style.display = 'flex';
            
            // 更新对话框内容
            const dialog = document.getElementById('restore-confirm-dialog');
            dialog.querySelector('h3').textContent = '恢复聊天记录';
            document.getElementById('restore-confirm-text').textContent = `恢复聊天记录将覆盖当前的所有消息，此操作不可撤销。确定要恢复 ${backupData.messageCount} 条消息吗？`;
            
            // 绑定确认按钮事件
            document.getElementById('confirm-restore-btn').onclick = function() {
                performRestore(backupData);
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            };
            
            // 绑定取消按钮事件
            document.getElementById('cancel-restore-btn').onclick = function() {
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            };
        }
        
        // 执行恢复操作
        function performRestore(backupData) {
            try {
                // 清空当前聊天记录
                appState.chatManager.messages.length = 0;
                
                // 恢复消息
                backupData.messages.forEach(msg => {
                    appState.chatManager.messages.push(msg);
                });
                
                // 保存到本地存储
                appState.chatManager.saveMessages();
                
                // 重新渲染聊天界面
                renderChatMessages();
                
                showBackupStatus(`成功恢复 ${backupData.messageCount} 条聊天记录`, 'success');
            } catch (error) {
                console.error('恢复聊天记录失败:', error);
                showBackupStatus('恢复聊天记录失败', 'error');
            }
        }
        
        // 显示备份操作状态
        function showBackupStatus(message, type) {
            const statusDiv = document.getElementById('backup-status');
            statusDiv.textContent = message;
            statusDiv.className = `backup-status backup-${type}`;
            statusDiv.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化个性签名
            loadSignature();
            
            // 监听个性签名编辑事件
            const signatureElement = document.getElementById('desktop-signature');
            signatureElement.addEventListener('blur', saveSignature);
            signatureElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur(); // 保存并退出编辑模式
                }
            });
            
            // 绑定确认删除按钮
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
            document.getElementById('cancel-delete-btn').addEventListener('click', cancelDelete);
            
            // 绑定导入确认按钮
            document.getElementById('confirm-import-btn').addEventListener('click', function() {
                const importData = window.currentImportData;
                if (importData) {
                    performImport(importData);
                    document.getElementById('import-confirm-dialog').style.display = 'none';
                }
            });
            
            document.getElementById('cancel-import-btn').addEventListener('click', function() {
                document.getElementById('import-confirm-dialog').style.display = 'none';
            });
            
            // 绑定恢复确认按钮
            document.getElementById('confirm-restore-btn').addEventListener('click', function() {
                const backupData = window.currentBackupData;
                if (backupData) {
                    performRestore(backupData);
                    document.getElementById('restore-confirm-dialog').style.display = 'none';
                }
            });
            
            document.getElementById('cancel-restore-btn').addEventListener('click', function() {
                document.getElementById('restore-confirm-dialog').style.display = 'none';
            });
            
            // 初始化桌面时间
            updateDesktopTime();
            setInterval(updateDesktopTime, 1000);
            
            // 初始化时显示桌面
            document.querySelectorAll('.interface').forEach(interface => {
                interface.classList.remove('active');
            });
            document.getElementById('desktop-interface').classList.add('active');
            currentInterface = 'desktop';
            
            const savedPersona = localStorage.getItem('aiPersona');
            if (savedPersona) {
                const persona = JSON.parse(savedPersona);
                document.getElementById('persona-input').value = persona.description || '';   
            }
            
            const currentConfig = appState.apiService.getCurrentConfig();
            if (currentConfig.apiKey) {
                document.getElementById('api-key').value = currentConfig.apiKey || '';
                document.getElementById('api-url').value = currentConfig.apiUrl || 'https://api.openai.com/v1';
                document.getElementById('api-provider').value = currentConfig.provider || 'openai';
                document.getElementById('temperature').value = 0.7;
                document.getElementById('max-tokens').value = 1000;
                
                if (currentConfig.model) {
                    const modelSelect = document.getElementById('model-select');
                    setTimeout(() => {  
                        const options = Array.from(modelSelect.options);
                        const option = options.find(opt => opt.value === currentConfig.model);
                        if (option) {
                            option.selected = true;
                            updateSelectedModel();
                        }
                    }, 100);
                }
            }   
            
            const savedCSS = localStorage.getItem('customCSS');    
            if (savedCSS) {
                document.getElementById('css-editor').value = savedCSS;
                appState.customCSS = savedCSS;
                
                let styleElement = document.getElementById('global-css');
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = 'global-css';
                    document.head.appendChild(styleElement);
                }
                styleElement.textContent = savedCSS;
            }
            
            updateTemperatureValue();
            document.getElementById('temperature').addEventListener('input', updateTemperatureValue);
            
            updateApiEndpoints();
            
            updateStatusIndicators();
            
            // 渲染聊天记录
            renderChatMessages();
            
            // 初始化音乐播放器
            musicPlayer.init();
        });
    </script>
</body>
</html>